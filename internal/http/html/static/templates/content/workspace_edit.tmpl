{{ template "layout" . }}

{{ define "content-header-title" }}
  <a href="{{ workspacesPath .Workspace.Organization }}">workspaces</a>
  /
  <a href="{{ workspacePath .Workspace.ID }}">{{ .Workspace.Name }}</a>
  /
  settings
{{ end }}

{{ define "content-header-links" }}
  {{ template "workspace-header-links" . }}
{{ end }}

{{ define "content" }}
  {{ $canUpdate := $.CurrentUser.CanAccessWorkspace .UpdateWorkspaceAction .Policy }}
  {{ $canDelete := $.CurrentUser.CanAccessWorkspace .DeleteWorkspaceAction .Policy }}
  {{ $canSetPermission := $.CurrentUser.CanAccessWorkspace .SetWorkspacePermissionAction .Policy }}
  {{ $canUnsetPermission := $.CurrentUser.CanAccessWorkspace .UnsetWorkspacePermissionAction .Policy }}
  {{ $canCreateRun := $.CurrentUser.CanAccessWorkspace .CreateRunAction .Policy }}
  {{ $canAddTag := $.CurrentUser.CanAccessWorkspace .AddTagsAction .Policy }}
  {{ $canRemoveTag := $.CurrentUser.CanAccessWorkspace .RemoveTagsAction .Policy }}
  <div class="mt-3">
    {{ with .Workspace.Connection }}
      <form action="{{ disconnectWorkspacePath $.Workspace.ID }}" method="POST">
        <button class="btn" id="disconnect-workspace-repo-button" {{ insufficient $canUpdate }}>
          Disconnect from {{ .Repo }} ({{ $.VCSProvider.CloudConfig }})
        </button>
      </form>
    {{ else }}
      <form action="{{ setupConnectionProviderWorkspacePath .Workspace.ID }}" method="GET">
        <button class="btn" id="list-workspace-vcs-providers-button" {{ insufficient $canUpdate }}>
          Connect to VCS
        </button>
      </form>
    {{ end }}
  </div>
  <hr class="my-4">
  <form class="flex flex-col gap-5" action="{{ updateWorkspacePath .Workspace.ID }}" method="POST">
    <div class="field">
      <label for="name">Name</label>
      <input class="text-input w-80" type="text" name="name" id="name" value="{{ .Workspace.Name }}" required>
    </div>
    <div class="field">
      <label for="description">Description</label>
      <textarea class="text-input w-96" rows="3" name="description" id="description" value="{{ .Workspace.Description }}"></textarea>
    </div>
    <fieldset class="border border-slate-900 px-3 py-3 flex flex-col gap-2">
      <legend>Execution mode</legend>
      <div class="form-checkbox">
        <input type="radio" name="execution_mode" id="remote" value="remote" {{ checked .Workspace.ExecutionMode "remote" }}/>
        <label for="remote">Remote</label>
        <span>Your plans and applies occur on Terraform Cloud's infrastructure. You and your team have the ability to review and collaborate on runs within the app.</span>
      </div>
      <div class="form-checkbox">
        <input type="radio" name="execution_mode" id="local" value="local" {{ checked .Workspace.ExecutionMode "local" }}/>
        <label for="local">Local</label>
        <span>Your plans and applies occur on machines you control. Terraform Cloud is only used to store and synchronize state.
</span>
      </div>
      <div class="form-checkbox">
        <input type="radio" name="execution_mode" id="agent" value="agent" {{ checked .Workspace.ExecutionMode "agent" }}/>
        <label for="agent">Agent</label>
        <span>Terraform Cloud will manage the plans and applies your agents execute.</span>
      </div>
    </fieldset>
    <fieldset class="border border-slate-900 px-3 py-3 flex flex-col gap-2">
      <legend>Apply method</legend>
      <div class="form-checkbox">
        <input type="radio" name="auto_apply" id="auto-apply" value="true" {{ checked .Workspace.AutoApply }}/>
        <label for="auto-apply">Auto apply</label>
        <span>Automatically apply changes when a Terraform plan is successful. Plans that have no changes will not be applied. If this workspace is linked to version control, a push to the default branch of the linked repository will trigger a plan and apply.</span>
      </div>
      <div class="form-checkbox">
        <input type="radio" name="auto_apply" id="manual-apply" value="false" {{ checked (not .Workspace.AutoApply) }}/>
        <label for="manual-apply">Manual apply</label>
        <span>Require an operator to confirm the result of the Terraform plan before applying. If this workspace is linked to version control, a push to the default branch of the linked repository will only trigger a plan and then wait for confirmation.</span>
      </div>
    </fieldset>
    <div class="field">
      <label for="terraform_version">Terraform version</label>
      <input class="text-input w-48" type="text" name="terraform_version" id="terraform_version" value="{{ .Workspace.TerraformVersion }}" required pattern="[0-9]+.[0-9]+.[0-9]+" title="Must provide version in the format <major>.<minor>.<patch>">
    </div>
    <div class="field">
      <label for="working_directory">Working directory</label>
      <input class="text-input w-96" type="text" name="working_directory" id="working_directory" value="{{ .Workspace.WorkingDirectory }}">
    </div>
    <div class="field">
      <button class="btn w-40" {{ insufficient $canUpdate }}>Save changes</button>
    </div>
  </form>
  <hr class="my-4">
  <h3 class="font-semibold text-lg">Permissions</h3>
  <div class="" id="permissions-container">
    <div>
      <table class="text-left">
        <thead class="bg-gray-100 border-t border-b">
          <tr>
            <th class="p-2">Team</th>
            <th class="p-2" colspan="2">Role</th>
          </tr>
        </thead>
        <tbody>
          <!-- always render implicit admin role permission for owners team -->
          <tr class="text-gray-400 border-b" id="permissions-owners">
            <td class="p-2">owners</td>
            <td class="p-2">admin</td>
          </tr>
          <!-- iterate through existing role assignments -->
          {{ range .Policy.Permissions }}
            {{ if eq .Team "owners" }}
              {{ continue }}
            {{ end }}
            <tr class="border-b" id="permissions-{{ .Team }}">
              <td class="p-2"><a href="{{ teamPath .TeamID }}">{{ .Team }}</a></td>
              <td class="p-2">
                <form class="" action="{{ setPermissionWorkspacePath $.Workspace.ID }}" method="POST">
                  <input name="team_name" value="{{ .Team }}" type="hidden">
                  <select name="role" id="role-select">
                    {{ $currentRole := .Role.String }}
                    {{ range $.Roles }}
                      <option value="{{ . }}" {{ selected .String $currentRole }}>{{ . }}</option>
                    {{ end }}
                  </select>
                  <button class="btn" {{ insufficient $canSetPermission }}>Update</button>
                </form>
              </td>
              <td>
                <form class="" action="{{ unsetPermissionWorkspacePath $.Workspace.ID }}" method="POST">
                  <input name="team_name" value="{{ .Team }}" type="hidden">
                  <button class="btn-danger" {{ insufficient $canUnsetPermission }}>Remove</button>
                </form>
              </td>
            </tr>
          {{ end }}
          <tr class="border-b">
            <form id="permissions-add-form" class="horizontal-form" action="{{ setPermissionWorkspacePath .Workspace.ID }}" method="POST"></form>
            <td class="p-2">
              <select form="permissions-add-form" name="team_name" id="permissions-add-select-team">
                <option value="">--team--</option>
                {{ range .Unassigned }}
                  <option value="{{ .Name }}">{{ .Name }}</option>
                {{ end }}
              </select>
            </td>
            <td class="p-2" id="permissions-add-role-container">
              <select form="permissions-add-form" name="role" id="permissions-add-select-role">
                <option value="">--role--</option>
                {{ range .Roles }}
                  <option value="{{ . }}">{{ . }}</option>
                {{ end }}
              </select>
              <button class="btn" id="permissions-add-button" form="permissions-add-form" {{ insufficient $canSetPermission }}>
                Add
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <hr class="my-4">
    <h3 class="font-semibold text-lg">Advanced</h3>
    <div class="flex flex-col gap-4 mt-2 mb-6">
      <form action="{{ startRunWorkspacePath .Workspace.ID }}" method="POST">
        <button id="queue-destroy-plan-button" class="btn-danger" {{ insufficient $canCreateRun }} onclick="return confirm('This will destroy all infrastructure in this workspace. Please confirm.')">
          Queue destroy plan
        </button>
        <input type="hidden" name="connected" value="{{ ne .Workspace.Connection nil }}">
        <input name="operation" value="destroy-all" type="hidden">
      </form>
      <form action="{{ deleteWorkspacePath .Workspace.ID }}" method="POST">
        <button id="delete-workspace-button" class="btn-danger" {{ insufficient $canDelete }} onclick="return confirm('Are you sure you want to delete?')">
          Delete workspace
        </button>
      </form>
    </div>
  </div>
{{ end }}
