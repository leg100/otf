{{ template "layout" . }}

{{ define "content-header-title" }}
  <div class="breadcrumbs">
    <ul>
      <li><a href="{{ workspacesPath .Workspace.Organization }}">workspaces</a></li>
      <li>{{ .Workspace.Name }}</li>
    </ul>
  </div>
{{ end }}

{{ define "content-header-links" }}
  {{ template "workspace-header-links" . }}
{{ end }}

{{ define "content" }}
  <div class="flex gap-6 flex-row">
    <div class="grow flex flex-col gap-4 basis-4/5">
      <div>{{ template "identifier" .Workspace }}</div>
      <div>
        <h3 class="text-lg font-bold my-2">Latest Run</h3>
        <div id="latest-run" hx-ext="sse" sse-connect="{{ watchWorkspacePath .Workspace.ID.String }}?latest=true" sse-swap="latest-run">
          {{ if .Workspace.LatestRun }}
            <div hx-get="{{ widgetRunPath .Workspace.LatestRun.ID.String }}" hx-trigger="load" hx-swap="outerHTML"></div>
          {{ else }}
            There are no runs for this workspace.
          {{ end }}
        </div>
      </div>
      <div role="tablist" class="tabs tabs-lifted">
        <input type="radio" checked="checked" name="my_tabs_2" role="tab" class="tab whitespace-nowrap" aria-label="Resources" id="resources-label"/>
        <div
          role="tabpanel"
          class="tab-content bg-base-100 border-base-300 rounded-box p-6"
          hx-get="{{ resourcesWorkspacePath .Workspace.ID.String }}"
          hx-trigger="load"
          hx-target="#resources-tab-content"
          hx-indicator="#resources-tab-spinner"
        >
          <div id="resources-tab-content"></div>
          <span id="resources-tab-spinner" class="loading loading-spinner htmx-indicator"></span>
        </div>
        <input type="radio" name="my_tabs_2" role="tab" class="tab whitespace-nowrap" aria-label="Outputs" id="outputs-label"/>
        <div
          role="tabpanel"
          class="tab-content bg-base-100 border-base-300 rounded-box p-6"
          hx-get="{{ outputsWorkspacePath .Workspace.ID.String }}"
          hx-trigger="load"
          hx-target="#outputs-tab-content"
          hx-indicator="#outputs-tab-spinner"
        >
          <div id="outputs-tab-content"></div>
          <span id="outputs-tab-spinner" class="loading loading-spinner htmx-indicator"></span>
        </div>
      </div>
    </div>
    <div class="flex gap-4 flex-col basis-1/5">
      {{ if .CanCreateRun }}
        <div>
          <h3 class="font-semibold mb-2">Actions</h3>
          <form id="workspace-start-run-form" action="{{ startRunWorkspacePath .Workspace.ID.String }}" method="POST">
            <select class="select" name="operation" id="start-run-operation" onchange="this.form.submit()">
              <option value="" selected>-- start run --</option>
              <option value="plan-only">plan only</option>
              {{ if .CanApply }}
                <option value="plan-and-apply">plan and apply</option>
              {{ end }}
            </select>
          </form>
        </div>
      {{ end }}
      <div><h3 class="font-semibold mb-2">Terraform Version</h3><a class="underline text-blue-700" href="{{ editWorkspacePath .Workspace.ID.String }}#terraform-version">{{ .Workspace.TerraformVersion }}</a></div>
      <div>
        <h3 class="font-semibold mb-2">Locking</h3>
        {{ with .LockButton }}
          {{ $statusColors := dict "unlocked" "bg-green-200" "locked" "bg-orange-200" }}
          <div class="flex flex-col gap-2 p-2 {{ get $statusColors .State }}">
            <span>{{ title .State }}</span>
            {{ if or $.CanLockWorkspace $.CanUnlockWorkspace }}
              <form action="{{ .Action }}" method="POST"><button class="btn" {{ disabled .Disabled }}>{{ .Text }}</button></form>
            {{ end }}
            <span class="text-sm">{{ .Message }}</span>
          </div>
        {{ end }}
      </div>
      {{ with .Workspace.Connection }}
        <div>Connected to <span class="bg-gray-200">{{ .Repo }} ({{ $.VCSProvider.String }})</span></div>
      {{ end }}
      <div class="flex flex-col gap-2">
        <h3 class="font-semibold mb-1">Tags</h3>
        {{ with .Workspace.Tags }}
          <div id="tags" class="tag-container">
            {{ range . }}
              <form action="{{ deleteTagWorkspacePath $.Workspace.ID.String }}" method="POST">
                <input type="hidden" name="tag_name" id="remove-tag-name" value="{{ . }}" required>
                {{ if $.CanRemoveTags }} {{ end }}
                <button id="button-remove-tag-{{ . }}" class="btn btn-sm btn-accent">
                  {{ . }}
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-6 w-6"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </form>
            {{ end }}
          </div>
        {{ end }}
        {{ if .CanAddTags }}
          {{ template "search-dropdown" .TagsDropdown }}
        {{ end }}
      </div>
    </div>
  </div>
{{ end }}
