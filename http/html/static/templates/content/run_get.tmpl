{{ template "layout" . }}

{{ define "stylesheet" }}
  <link rel="stylesheet" href="{{ addHash "/static/css/terminal.css" }}">
{{ end }}

{{ define "container-header" }}
  <a href="{{ workspacesPath .Workspace.Organization }}">workspaces</a>
  /
  <a href="{{ workspacePath .Workspace.ID }}">{{ .Workspace.Name }}</a>
  /
  <a href="{{ runsPath .Workspace.ID }}">runs</a>
  /
  {{ .Run.ID }}
{{ end }}

{{ define "content" }}
  <script type="text/javascript">
    window.addEventListener('load', (e) => {
      watchRunUpdates({{ watchWorkspacePath .Workspace.ID }}, {{ randAlphaNum 6 }}, {{ .Run.ID }});
    });
  </script>
  <div id="run-status">
    {{ template "run-item" .Run }}
  </div>
  <div id="plan" class="item">
    <div class="item-heading">
      <span class="inline-heading">plan</span>
      {{ template "phase-status" .Run.Plan }}
    </div>
    <div>
      <div class="term-container">
        {{- trimHTML .PlanLogs.ToHTML }}<div id="tailed-plan-logs"></div></div>
    </div>
  </div>
  <div id="apply" class="item">
    <div class="item-heading">
      <span class="inline-heading">apply</span>
      {{ template "phase-status" .Run.Apply }}
    </div>
    <div class="term-container">
      {{- trimHTML .ApplyLogs.ToHTML }}<div id="tailed-apply-logs"></div></div>
  </div>
  {{ if not .PlanLogs.IsEnd }}
    <script type="text/javascript">
      setupTail({{ tailRunPath .Run.ID }}, 'plan', {{ .PlanLogs.NextOffset }}, {{ randAlphaNum 6 }});
    </script>
  {{ end }}
  {{ if not .ApplyLogs.IsEnd }}
    <script type="text/javascript">
      setupTail({{ tailRunPath .Run.ID }}, 'apply', {{ .ApplyLogs.NextOffset }}, {{ randAlphaNum 6 }});
    </script>
  {{ end }}
  <div id="run-confirm-container" style="{{ if ne .Run.Status "planned" }}display: none;{{ end }}">
    <form action="{{ applyRunPath .Run.ID }}" method="POST">
      <button>Confirm & Apply</button>
    </form>
    <form action="{{ discardRunPath .Run.ID }}" method="POST">
      <button>Discard Run</button>
    </form>
  </div>
{{ end }}

