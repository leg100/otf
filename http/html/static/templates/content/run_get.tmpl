{{ template "layout" . }}

{{ define "title" }}{{ .Content.Run.ID }}{{ end }}

{{ define "stylesheet" }}
  <link rel="stylesheet" href="{{ addHash "/static/css/terminal.css" }}">
{{ end }}

{{ define "container-header" }}
  <a href="{{ listWorkspacePath .Content.Run }}">workspaces</a>
  /
  <a href="{{ getWorkspacePath .Content.Run }}">{{ .Content.Run.WorkspaceName }}</a>
  /
  <a href="{{ listRunPath .Content.Run }}">runs</a>
  /
  {{ .Content.Run.ID }}
{{ end }}

{{ define "content" }}
  <script type="text/javascript">
    window.addEventListener('load', (e) => {
      watchRunUpdates({{ watchWorkspacePath .Content.Run }}, {{ randAlphaNum 6 }}, {{ .Content.Run.ID }});
    });
  </script>
  <div id="run-status">
    {{ template "run-status" .Content.Run }}
  </div>
  {{ template "identifier" .Content.Run }}
  <div id="plan" class="item">
    <div class="item-heading">
      <span class="inline-heading">plan</span>
      {{ template "phase-status" .Content.Run.Plan }}
    </div>
    <div>
      <div class="term-container">
        {{- trimHTML .Content.PlanLogs.ToHTML }}<div id="tailed-plan-logs"></div></div>
    </div>
  </div>
  <div id="apply" class="item">
    <div class="item-heading">
      <span class="inline-heading">apply</span>
      {{ template "phase-status" .Content.Run.Apply }}
    </div>
    <div class="term-container">
      {{- trimHTML .Content.ApplyLogs.ToHTML }}<div id="tailed-apply-logs"></div></div>
  </div>
  {{ if not .Content.PlanLogs.IsEnd }}
    <script type="text/javascript">
      setupTail({{ tailRunPath .Content.Run }}, 'plan', {{ .Content.PlanLogs.NextOffset }}, {{ randAlphaNum 6 }});
    </script>
  {{ end }}
  {{ if not .Content.ApplyLogs.IsEnd }}
    <script type="text/javascript">
      setupTail({{ tailRunPath .Content.Run }}, 'apply', {{ .Content.ApplyLogs.NextOffset }}, {{ randAlphaNum 6 }});
    </script>
  {{ end }}
  <div id="run-confirm-container" style="{{ if ne .Content.Run.Status "planned" }}display: none;{{ end }}">
    <form action="{{ applyRunPath .Content.Run }}" method="POST">
      <button>Confirm & Apply</button>
    </form>
    <form action="{{ discardRunPath .Content.Run }}" method="POST">
      <button>Discard Run</button>
    </form>
  </div>
{{ end }}

